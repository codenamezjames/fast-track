name: Deploy to Media Server

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Deploy Fast Track
        run: |
          cd /opt/fast-track

          # Pull latest changes
          git fetch origin main
          git checkout main
          git pull origin main

          # Rebuild and restart containers
          docker compose build
          docker compose down
          docker compose up -d

          # Wait and health check
          sleep 10
          curl -sf http://localhost:3000/api/health || echo "API health check failed"
          curl -sf http://localhost:8080 || echo "Web health check failed"

          # Cleanup
          docker image prune -f

          echo "Deployment complete!"
